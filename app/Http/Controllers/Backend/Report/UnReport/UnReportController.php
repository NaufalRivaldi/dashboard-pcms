<?php
// ----------------------------------------------------------------------------
namespace App\Http\Controllers\Backend\Report\UnReport;
// ----------------------------------------------------------------------------
use App\Http\Controllers\Controller;
use Illuminate\Http\Request;
// ----------------------------------------------------------------------------
use App\Models\Cabang;
use App\Models\Summary;
// ----------------------------------------------------------------------------
use Carbon\Carbon;
use Auth;
use DB;
use PDF;
// ----------------------------------------------------------------------------
class UnReportController extends Controller
{
    // ------------------------------------------------------------------------
    public function index()
    {
        // --------------------------------------------------------------------
        $data = new \stdClass; $item = new \stdClass;
        $data->title    = "List Cabang Belum Melakukan Import Data";
        $data->item     = $item;
        // --------------------------------------------------------------------
        // Init data
        // --------------------------------------------------------------------
        $item->filterDate = viewDate(Carbon::now()->firstOfMonth()->format('Y-m-d'));
        // --------------------------------------------------------------------
        return view('backend.report.unreport.index', (array) $data);
        // --------------------------------------------------------------------
    }
    // ------------------------------------------------------------------------

    // ------------------------------------------------------------------------
    public function search(Request $request)
    {
        // --------------------------------------------------------------------
        $data = new \stdClass;
        // --------------------------------------------------------------------
        try {
            // ----------------------------------------------------------------
            $input = $request->all();
            $bulan = Carbon::parse('01 '.$input['filterDate'])->format('m');
            $tahun = Carbon::parse('01 '.$input['filterDate'])->format('Y');
            // ----------------------------------------------------------------
            $summary    = Summary::where('bulan', $bulan)->where('tahun', $tahun)->pluck('cabang_id')->toArray();
            $cabang     = Cabang::with('owner')->whereNotIn('id', $summary)->get();
            // ----------------------------------------------------------------
            $data->status   = true;
            $data->message  = "Data berhasil difilter";
            $data->results  = $cabang;
            // ----------------------------------------------------------------
            return response()->json($data);
            // ----------------------------------------------------------------
        } catch (\Throwable $th) {
            $data->status   = false;
            $data->message  = "Data gagal difilter!";
            // ----------------------------------------------------------------
            return response()->json($data);
            // ----------------------------------------------------------------
        }
        // --------------------------------------------------------------------
    }
    // ------------------------------------------------------------------------

    // ------------------------------------------------------------------------
    public function export(Request $request)
    {
        // --------------------------------------------------------------------
        $data = new \stdClass;
        // --------------------------------------------------------------------
        $input = $request->all();
        $bulan = Carbon::parse('01 '.$input['filter_date'])->format('m');
        $tahun = Carbon::parse('01 '.$input['filter_date'])->format('Y');
        // --------------------------------------------------------------------
        $summary    = Summary::where('bulan', $bulan)->where('tahun', $tahun)->pluck('cabang_id')->toArray();
        $cabang     = Cabang::with('owner')->whereNotIn('id', $summary)->get();
        // --------------------------------------------------------------------
        $data->periode  = $input['filter_date'];
        $data->results  = $cabang;
        // --------------------------------------------------------------------
        return view('pdf.report.unreport', (array) $data);
        // --------------------------------------------------------------------
    }
    // ------------------------------------------------------------------------
}
// ----------------------------------------------------------------------------